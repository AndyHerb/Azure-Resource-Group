Install-Module -Repository 'PSGallery' -Name 'xNetworking'
Install-Module -Repository 'PSGallery' -Name 'xActiveDirectory'
Install-Module -Repository 'PSGallery' -Name 'xPendingReboot'

$dscPublishSettings = @{
    ConfigurationPath = "C:\Users\BNRS\source\Workspaces\Client Services\Configurations\ARM\Coric-ARM-Deployment-Refactored\DSC\CreateADPDC.ps1\CreateADPDC.ps1"
    OutputArchivePath = ".\CreateADPDC.ps1.zip"
    Force = $True
}

Publish-AzureRmVMDscConfiguration @dscPublishSettings

$dscPublishSettings = @{
    ResourceGroupName = $vm.ResourceGroupName
    StorageAccountName = 'sacor0021admin'
    ConfigurationPath = "C:\Users\BNRS\source\Workspaces\Client Services\Configurations\ARM\Coric-ARM-Deployment-Refactored\DSC\CreateADPDC.ps1\CreateADPDC.ps1"
    Force = $True
}

Publish-AzureRmVMDscConfiguration @dscPublishSettings

$vm = Get-AzureRMVM | Where Name -eq 'vmcor0021-dc01'

if (-not $adminCreds) { $adminCreds = Get-Credential }

$dscSettings = @{
    ResourceGroupName     = $vm.ResourceGroupName
    VMName                = $vm.Name
    ArchiveStorageAccountName = 'sacor0021admin'
    ArchiveBlobName       = 'CreateADPDC.ps1.zip'
    ConfigurationName     = 'CreateADForest'
    ConfigurationArgument = @{
        adminCreds = $adminCreds
        domainName = 'cor0021.Hosted'
    }
    Version = '2.76'
}

Set-AzureRmVMDscExtension @dscSettings
